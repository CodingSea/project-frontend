<div class="container">
  <app-header></app-header>
  <app-sidebar></app-sidebar>

  <div class="pm-container">
    <div class="service-dashbaord_33-2">
      <div class="body_33-3">
        <div class="div_33-4">
          <div class="main_33-71">
            <div class="div_33-96">
              <div class="main_div">

                <!-- ===== Page Header Section (aligned with cards) ===== -->
                <div class="page-header-wrapper">
                  <header class="page-header">
                    <div class="page-header-left">
                      <h1>Projects</h1>
                      <app-excel-importer></app-excel-importer>
                      <input type="file" id="fileUpload" (change)="onFileSelected($event)" hidden />
                    </div>

                    <div class="page-header-right">
                      <div class="search-box">
                        <input
                          type="text"
                          [(ngModel)]="searchQuery"
                          (input)="onFilterChange()"
                          placeholder="Search projects..."
                        />
                      </div>
                      <select [(ngModel)]="selectedFilter" (change)="onFilterChange()">
                        <option value="all">All Projects</option>
                        <option value="active">Active</option>
                        <option value="on hold">On Hold</option>
                      </select>
                    </div>
                  </header>

                  <div class="projects-summary">
                    <p class="total-projects-text">Total Projects: {{ totalProjects }}</p>
                  </div>
                </div>

                <!-- ===== Project Cards ===== -->
                <div class="pm-cards">
                  <!-- Add New Project (Admin only) -->
                  <article
                    class="pm-card add-new"
                    *ngIf="isAdmin"
                    (click)="openNewProject()"
                  >
                    <div class="pm-plus-circle">
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path
                          d="M12 5v14M5 12h14"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                        />
                      </svg>
                    </div>
                    <h3>Add New Project</h3>
                    <p>Start a new project and invite your team members</p>
                  </article>

                  <!-- Dynamic Project Cards -->
                  <article class="pm-card" *ngFor="let p of projects" (click)="onCardClick(p)">
                    <header class="pm-card-header">
                      @if (p.name.length <= 25) {
                        <h3>{{ p.name }}</h3>
                      } @else {
                        <h3>{{ getLimitedString(p.name, 25) }}</h3>
                      }

                      <span class="pm-pill" [attr.data-status]="p.status">
                        {{ p.status || 'Unknown' }}
                      </span>

                      <!-- Menu visible only for Admin -->
                      <div
                        class="pm-card-menu"
                        *ngIf="isAdmin"
                        (click)="$event.stopPropagation()"
                      >
                        <button
                          class="dots"
                          type="button"
                          aria-label="Options"
                          (click)="toggleMenu(p.projectID, $event)"
                        >
                          ⋮
                        </button>
                        <ul class="menu" *ngIf="openMenuId === p.projectID">
                          <li (click)="goToEdit(p, $event)">Edit</li>
                          <li (click)="deleteProject(p)">Delete</li>
                        </ul>
                      </div>
                    </header>

                    <p class="pm-desc">{{ p.description }}</p>

                    <div class="pm-members">
                      <span class="pm-more">
                        <p class="clickable" (click)="openServicesModal(p, $event)">
                          Services: {{ p.services?.length || 0 }}
                        </p>
                        <p class="clickable" (click)="openMembersModal(p, $event)">
                          Members: {{ p.members || 0 }}
                        </p>
                      </span>
                    </div>

                    <footer class="pm-card-footer">
                      <span *ngIf="p.deadline" class="pm-due">
                        Due: {{ p.deadline | date: 'MMM d' }}
                      </span>
                      <div class="pm-progress">
                        <div
                          class="pm-progress-fill"
                          [style.width.%]="p.progress || 0"
                        ></div>
                      </div>
                      <span class="pm-progress-label">
                        {{ formatDecimal(p.progress || 0) }}%
                      </span>
                    </footer>
                  </article>
                </div>

                <!-- ===== Pagination ===== -->
                <div class="pagination" *ngIf="projects.length">
                  <button (click)="jumpToPage(true)" [disabled]="currentPage === 1">«</button>
                  <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">‹</button>

                  <button
                    *ngFor="let page of pageNumbers"
                    (click)="changePage(page)"
                    [class.active]="currentPage === page"
                  >
                    {{ page }}
                  </button>

                  <button
                    (click)="changePage(currentPage + 1)"
                    [disabled]="currentPage >= getTotalPages()"
                  >›</button>
                  <button
                    (click)="jumpToPage(false)"
                    [disabled]="currentPage >= getTotalPages()"
                  >»</button>


                </div>

                <!-- ===== Members Modal ===== -->
                <div
                  class="pm-modal-backdrop"
                  *ngIf="showMembersModal"
                  (click)="closeMembersModal()"
                ></div>

                <div
                  class="pm-modal"
                  *ngIf="showMembersModal"
                  (click)="$event.stopPropagation()"
                >
                  <header class="pm-modal-header">
                    <strong>Team Members</strong>
                    <button class="pm-close" (click)="closeMembersModal()">×</button>
                  </header>

                  <div class="members-table">
                    <table>
                      <thead>
                        <tr>
                          <th>Member</th>
                          <th>Role</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let m of selectedMembers">
                          <td>
                            <div class="member-info clickable" (click)="goToUserProfile(m.id)">
                              <div class="avatar">
                                <img
                                  [src]="getMemberAvatar(m.image)"
                                  alt="User"
                                  (error)="onMemberImageError($event)"
                                />
                              </div>
                              <span>{{ m.name }}</span>
                            </div>
                          </td>
                          <td>{{ m.role }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- ✅ ===== Services Modal ===== -->
                <div
                  class="pm-modal-backdrop"
                  *ngIf="showServicesModal"
                  (click)="closeServicesModal()"
                ></div>

                <div
                  class="pm-modal"
                  *ngIf="showServicesModal"
                  (click)="$event.stopPropagation()"
                >
                  <header class="pm-modal-header">
                    <strong>Project Services</strong>
                    <button class="pm-close" (click)="closeServicesModal()">×</button>
                  </header>

                  <div class="members-table">
                    <table>
                      <thead>
                        <tr>
                          <th>Service</th>
                          <th>Deadline</th>
                          <th>Chief</th>
                          <th>Manager</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr *ngFor="let s of selectedServices">
                          <td class="clickable" (click)="goToService(s)">
                            {{ s.name }}
                          </td>
                          <td>{{ s.deadline | date: 'MMM d, yyyy' }}</td>
                          <td
                            class="clickable"
                            (click)="goToUserProfile(s.chief?.id)"
                          >
                            {{ s.chief?.first_name }} {{ s.chief?.last_name }}
                          </td>
                          <td
                            class="clickable"
                            (click)="goToUserProfile(s.projectManager?.id)"
                          >
                            {{ s.projectManager?.first_name }} {{ s.projectManager?.last_name }}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- ===== New Project Modal ===== -->
                <ng-container *ngIf="showNewProject">
                  <div class="pm-modal-backdrop" (click)="closeNewProject()"></div>
                  <div
                    class="pm-modal"
                    role="dialog"
                    aria-modal="true"
                    aria-label="Create Project"
                    (click)="$event.stopPropagation()"
                  >
                    <header class="pm-modal-header">
                      <strong>Create Project</strong>
                      <button
                        class="pm-close"
                        type="button"
                        (click)="closeNewProject()"
                        aria-label="Close"
                      >
                        ×
                      </button>
                    </header>

                    <form
                      #projectForm="ngForm"
                      (ngSubmit)="saveNewProject(projectForm)"
                    >
                      <label class="pm-label">
                        Project name<span class="req">*</span>
                      </label>
                      <input
                        class="pm-input"
                        type="text"
                        name="name"
                        required
                        pattern="^[A-Za-z\u0600-\u06FF0-9 ]{3,50}$"
                        #nameField="ngModel"
                        [(ngModel)]="newProject.name"
                        placeholder="e.g., Website Revamp"
                      />
                      <div
                        *ngIf="
                          nameField.invalid && (nameField.dirty || nameField.touched)
                        "
                        class="pm-error"
                      >
                        <small *ngIf="nameField.errors?.['required']"
                          >Project name is required.</small
                        >
                        <small *ngIf="nameField.errors?.['pattern']"
                          >Invalid name format.</small
                        >
                      </div>

                      <label class="pm-label">Description</label>
                      <textarea
                        class="pm-textarea"
                        name="description"
                        rows="3"
                        [(ngModel)]="newProject.description"
                        placeholder="(optional) brief summary"
                      ></textarea>

                      <div class="pm-row-2">
                        <div>
                          <label class="pm-label">Status</label>
                          <select
                            class="pm-input"
                            name="status"
                            [(ngModel)]="newProject.status"
                          >
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                          </select>
                        </div>
                      </div>

                      <div class="pm-actions">
                        <button
                          type="button"
                          class="pm-btn"
                          (click)="closeNewProject()"
                        >
                          Cancel
                        </button>
                        <button
                          type="submit"
                          class="pm-btn pm-btn-primary"
                          [disabled]="projectForm.invalid"
                        >
                          Create
                        </button>
                      </div>
                    </form>
                  </div>
                </ng-container>

                <!-- ===== Edit Project Modal ===== -->
                <ng-container *ngIf="showEditProject">
                  <div class="pm-modal-backdrop" (click)="closeEditProject()"></div>
                  <div
                    class="pm-modal"
                    role="dialog"
                    aria-modal="true"
                    aria-label="Edit Project"
                    (click)="$event.stopPropagation()"
                  >
                    <header class="pm-modal-header">
                      <strong>Edit Project</strong>
                      <button
                        class="pm-close"
                        type="button"
                        (click)="closeEditProject()"
                        aria-label="Close"
                      >
                        ×
                      </button>
                    </header>

                    <form
                      #projectForm2="ngForm"
                      (ngSubmit)="updateProject(projectForm2)"
                    >
                      <label class="pm-label">
                        Project name<span class="req">*</span>
                      </label>
                      <input
                        class="pm-input"
                        type="text"
                        name="name"
                        required
                        pattern="^[A-Za-z0-9 ]{3,50}$"
                        [(ngModel)]="editProject.name"
                        placeholder="e.g., Website Revamp"
                      />

                      <label class="pm-label">Description</label>
                      <textarea
                        class="pm-textarea"
                        name="description"
                        rows="3"
                        [(ngModel)]="editProject.description"
                        placeholder="(optional) brief summary"
                      ></textarea>

                      <div class="pm-row-2">
                        <div>
                          <label class="pm-label">Status</label>
                          <select
                            class="pm-input"
                            name="status"
                            [(ngModel)]="editProject.status"
                          >
                            <option value="Active">Active</option>
                            <option value="On Hold">On Hold</option>
                          </select>
                        </div>
                      </div>

                      <div class="pm-actions">
                        <button
                          type="button"
                          class="pm-btn"
                          (click)="closeEditProject()"
                        >
                          Cancel
                        </button>
                        <button type="submit" class="pm-btn pm-btn-primary">
                          Update
                        </button>
                      </div>
                    </form>
                  </div>
                </ng-container>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
