<div class="container">
  <app-header></app-header>
  <app-sidebar />

  <div class="pm-container">
    <div class="service-dashbaord_33-2">
      <div class="body_33-3">
        <div class="div_33-4">
          <div class="main_33-71">
            <div class="div_33-96">
              <div class="main-div">
                <!-- ===== Stats ===== -->
                <ul class="stats-list">
                  <li class="stat-item">
                    <span class="text-total-projects">Total Services</span>
                    <span class="text-24">{{ servicesInfo.totalServices }}</span>
                  </li>
                  <li class="stat-item">
                    <span class="text-active-tasks">Backlogged Tasks</span>
                    <span class="text-156">{{ servicesInfo.backloggedTasks }}</span>
                  </li>
                  <li class="stat-item">
                    <span class="text-active-tasks">Active Tasks</span>
                    <span class="text-156">{{ servicesInfo.activeTasks }}</span>
                  </li>
                  <li class="stat-item">
                    <span class="text-active-tasks">Completed Tasks</span>
                    <span class="text-156">{{ servicesInfo.completedTasks }}</span>
                  </li>
                  <li class="stat-item">
                    <span class="text-team-members">Team Members</span>
                    <span class="text-32">{{ servicesInfo.totalMembers }}</span>
                  </li>
                  <li class="stat-item">
                    <span class="text-completion-rate">Completion Rate</span>
                    <span class="text-87">{{ formatDecimal(servicesInfo.completionRate) }}%</span>
                  </li>
                </ul>
              </div>

              <div class="header-actions">
                <div class="filter-container">
                  <div class="search-filter-row">
                    <input
                      type="text"
                      placeholder="Search services..."
                      [(ngModel)]="searchTerm"
                      (input)="applySearch()"
                      class="pm-input search-box"
                    />
                    <select [(ngModel)]="selectedStatus" (change)="applySearch()" class="pm-input filter-box">
                      <option value="">All Status</option>
                      <option *ngFor="let s of statuses" [value]="s">{{ s }}</option>
                    </select>
                    <select [(ngModel)]="hasTasksFilter" (change)="applySearch()" class="pm-input filter-box">
                      <option value="">All Services</option>
                      <option value="true">Has Tasks</option>
                      <option value="false">No Tasks</option>
                    </select>
                  </div>
                </div>
                <button class="back-btn" (click)="goBack()">Back</button>
              </div>

              <div class="div_33-138">
                <div class="recent-services">
                  <span class="text-recent-projects">Recent Services:</span>
                </div>

                <div class="pm-cards">
                  <!-- Add new (admin only) -->
                  <article class="pm-card add-new" *ngIf="isAdmin" (click)="openNewService()">
                    <div class="pm-plus-circle">
                      <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path
                          d="M12 5v14M5 12h14"
                          stroke="currentColor"
                          stroke-width="2"
                          stroke-linecap="round"
                        />
                      </svg>
                    </div>
                    <h3>Add New Service</h3>
                    <p>Start a new service and invite your team members</p>
                  </article>

                  <!-- Dynamic service cards -->
                  <article
                    class="pm-card"
                    *ngFor="let p of filteredServices"
                    (click)="onCardClick(p)"
                  >
                    <header class="pm-card-header">
                      @if (p.name.length <= 15) {
                        <h3>{{ p.name }}</h3>
                      } @else {
                        <h3>{{ getLimitedString(p.name, 15) }}</h3>
                      }
                      <span class="pm-pill" [attr.data-status]="p.status">
                        {{ p.status }}
                      </span>

<!-- Menu (hidden visually if no actions available) -->
<div class="pm-card-menu" (click)="$event.stopPropagation()">
  <button
    class="dots"
    type="button"
    aria-label="Options"
    (click)="toggleMenu(p.serviceID, $event)"
    [style.visibility]="(canEditService(p) || canDeleteService()) ? 'visible' : 'hidden'"
  >
    ⋮
  </button>

  <ul class="menu" *ngIf="openMenuId === p.serviceID">
    <li *ngIf="canEditService(p)" (click)="goToEdit(p, $event)">Edit</li>
    <li *ngIf="canDeleteService()" (click)="deleteService(p)">Delete</li>
  </ul>
</div>

                    </header>

                    <p class="pm-desc">{{ p.description }}</p>
                    <p class="pm-members">Members: {{ p.memberCount }}</p>

                    <footer class="pm-card-footer">
                      <span class="pm-due">Due: {{ p.deadline | date: 'MMM d' }}</span>
                      @if(p.taskBoard?.cards?.length === 0) {
                        <span class="pm-progress-label">No Tasks</span>
                      } @else {
                        <div class="pm-progress">
                          <div
                            class="pm-progress-fill"
                            [style.width.%]="p.completionRate?.toFixed(2)"
                          ></div>
                        </div>
                        <span class="pm-progress-label">{{ formatDecimal(p.completionRate!) }}%</span>
                      }
                    </footer>
                  </article>
                </div>

                <!-- Pagination -->
                <div class="pagination" *ngIf="totalPages > 1">
                  <button (click)="goToFirstPage()" [disabled]="currentPage === 1">&lt;&lt;</button>
                  <button (click)="prevPage()" [disabled]="currentPage === 1">&lt;</button>
                  <button
                    *ngFor="let page of pages"
                    [class.active]="currentPage === page"
                    (click)="goToPage(page)"
                  >
                    {{ page }}
                  </button>
                  <button (click)="nextPage()" [disabled]="currentPage === totalPages">&gt;</button>
                  <button (click)="goToLastPage()" [disabled]="currentPage === totalPages">&gt;&gt;</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="pm-modal-backdrop" *ngIf="showNewService" (click)="closeNewService()"></div>

    <div class="pm-modal" *ngIf="showNewService" (click)="$event.stopPropagation()">
      <header class="pm-modal-header">
        <strong>Create New Service</strong>
        <button class="pm-close" type="button" (click)="closeNewService()">×</button>
      </header>

      <app-service-form
        [projectId]="projectIdNum"
        (submitted)="onServiceCreated()"
        (cancelled)="closeNewService()"
      ></app-service-form>
    </div>
  </div>
</div>
