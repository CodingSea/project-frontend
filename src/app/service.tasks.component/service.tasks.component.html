<div class="container">
  <app-header></app-header>
  <app-sidebar></app-sidebar>

  <div class="kanban-container">

    <!-- Tabs -->
    <div class="page-tabs">
      <div [class.active]="isTaskboardSelected" (click)="selectSection(true)">Board</div>
      <div [class.active]="!isTaskboardSelected" (click)="selectSection(false)">Discussion</div>
    </div>

    <!-- ===================== Board Header ===================== -->
    <header class="board-header">
      <div class="board-info">
        <div class="board-title">
          <h2>{{ taskBoard?.service?.name }}</h2>
          <div class="subtext">
            <span>
              Led by {{ taskBoard?.service?.chief?.first_name }}
              {{ taskBoard?.service?.chief?.last_name }}
            </span>
            <hr>
            <span *ngIf="taskBoard?.service?.projectManager">
              Project Manager:
              {{ taskBoard?.service?.projectManager?.first_name }}
              {{ taskBoard?.service?.projectManager?.last_name }}
            </span>
          </div>
        </div>

        <div class="header-meta">
          <span class="deadline-label">Deadline:</span>
          <span class="deadline">{{ taskBoard?.service?.deadline | date: 'dd/MM/yyyy' }}</span>
        </div>
      </div>

      <div class="progress-wrapper">
        <span class="progress-text">Progress</span>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="servicesInfo.completionRate"></div>
        </div>
        <span class="progress-percent">{{ formatDecimal(servicesInfo.completionRate) }}%</span>
      </div>

      <!-- ✅ Actions Row -->
      <div class="actions-row">
        <!-- Add Task: Chief / Manager / Resource / Admin -->
<button
  *ngIf="isTaskboardSelected && (isAdmin || isChief || isManager)"
  class="btn-primary"
  (click)="openCreateModal()">
  + Add Task
</button>



        <button class="btn-secondary" (click)="goBack()">Back</button>
      </div>
    </header>

    <!-- ===================== Kanban Board ===================== -->
    <div class="modern-kanban-board" *ngIf="showKanban && isTaskboardSelected">
      <jqxKanban
        #kanbanReference
        *ngIf="columns && dataAdapter"
        [width]="'100%'"
        [columns]="columns"
        [source]="dataAdapter"
        (onItemAttrClicked)="(isChief || isAdmin) ? openEditModal($event.args.item) : null"
        (onItemMoved)="onItemMoved($event)">
      </jqxKanban>
    </div>

    <!-- ===================== Create Task Modal ===================== -->
    <div class="modal-backdrop" *ngIf="showCreateModal" (click)="closeCreateModal()"></div>
    <div class="modal-container" *ngIf="showCreateModal">
      <div class="modal-header">
        <h2>Create Task</h2>
        <button class="close-btn" (click)="closeCreateModal()">✕</button>
      </div>

      <p class="modal-subtitle">Fill the details below to add a new task</p>

      <form (ngSubmit)="submitCreateTask()" #createForm="ngForm" class="modal-form">

        <div class="form-group">
          <label>Title <span>*</span></label>
          <input type="text" class="form-input" [(ngModel)]="createModel.title" name="title" placeholder="Task title…" required />
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea class="form-textarea" [(ngModel)]="createModel.description" name="description" placeholder="Short description…"></textarea>
        </div>

        <!-- ✅ Assign To Dropdown -->
        <div class="form-group">
          <label>Assign To</label>
          <div class="dropdown-select" (click)="toggleDropdown('create')">
            <div class="dropdown-selected">Select user(s)</div>
            <div class="dropdown-arrow">▼</div>
          </div>

          <div class="dropdown-list" *ngIf="dropdownOpenCreate">
            <div
              class="dropdown-item"
              *ngFor="let u of users"
              (click)="toggleUserSelection(u.id, 'create')"
              [class.selected]="createModel.assignedUserIds.includes(u.id)">
              {{ u.first_name }} {{ u.last_name }}
            </div>
          </div>

          <div class="selected-users" *ngIf="createModel.assignedUserIds.length > 0">
            <div class="user-pill" *ngFor="let uid of createModel.assignedUserIds">
              {{ getUserNameById(uid) }}
              <span class="remove" (click)="removeUser(uid, 'create')">×</span>
            </div>
          </div>
        </div>

        <div class="form-2col">
          <div class="form-group">
            <label>Tags <span class="muted">(comma separated)</span></label>
            <input type="text" class="form-input" [(ngModel)]="createModel.tags" name="tags" placeholder="UI, API, urgent" />
          </div>

          <div class="form-group">
            <label>Priority</label>
            <select class="form-input" [(ngModel)]="createModel.priority" name="priority" (change)="updatePriorityColor(createModel)">
              <option value="low">Low Priority</option>
              <option value="medium">Medium Priority</option>
              <option value="high">High Priority</option>
            </select>
          </div>
        </div>

        <div class="modal-buttons">
          <button type="button" class="btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn-primary" [disabled]="!createForm.form.valid">Create</button>
        </div>
      </form>
    </div>

    <!-- ===================== Edit Task Modal ===================== -->
    <div class="modal-backdrop" *ngIf="showEditModal" (click)="closeEditModal()"></div>
    <div class="modal-container" *ngIf="showEditModal">
      <div class="modal-header">
        <h2>Edit Task</h2>
        <button class="close-btn" (click)="closeEditModal()">✕</button>
      </div>

      <p class="modal-subtitle">Update the task information</p>

      <form (ngSubmit)="submitEditTask()" #editForm="ngForm" class="modal-form">
        <div class="form-group">
          <label>Title <span>*</span></label>
          <input type="text" class="form-input" [(ngModel)]="editModel.title" name="editTitle" required [readonly]="!isChief && !isAdmin"/>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea class="form-textarea" [(ngModel)]="editModel.description" name="editDescription" [readonly]="!isChief && !isAdmin"></textarea>
        </div>

        <!-- ✅ Assign To Dropdown -->
        <div class="form-group">
          <label>Assign To</label>
          <div class="dropdown-select" (click)="(isChief || isAdmin) && toggleDropdown('edit')">
            <div class="dropdown-selected">Select user(s)</div>
            <div class="dropdown-arrow">▼</div>
          </div>

          <div class="dropdown-list" *ngIf="dropdownOpenEdit && (isChief || isAdmin)">
            <div
              class="dropdown-item"
              *ngFor="let u of users"
              (click)="toggleUserSelection(u.id, 'edit')"
              [class.selected]="editModel.assignedUserIds.includes(u.id)">
              {{ u.first_name }} {{ u.last_name }}
            </div>
          </div>

          <div class="selected-users" *ngIf="editModel.assignedUserIds.length > 0">
            <div class="user-pill" *ngFor="let uid of editModel.assignedUserIds">
              {{ getUserNameById(uid) }}
              <span class="remove" *ngIf="isChief || isAdmin" (click)="removeUser(uid, 'edit')">×</span>
            </div>
          </div>
        </div>

        <div class="form-2col">
          <div class="form-group">
            <label>Tags <span class="muted">(comma separated)</span></label>
            <input type="text" class="form-input" [(ngModel)]="editModel.tags" name="editTags" [readonly]="!isChief && !isAdmin" />
          </div>

          <div class="form-group">
            <label>Priority</label>
            <select class="form-input" [(ngModel)]="editModel.priority" name="editPriority"
              (change)="updatePriorityColor(editModel)" [disabled]="!isChief && !isAdmin">
              <option value="low">Low Priority</option>
              <option value="medium">Medium Priority</option>
              <option value="high">High Priority</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Column</label>
          <select class="form-input" [(ngModel)]="editModel.column" name="editColumn" [disabled]="!isChief && !isAdmin">
            <option value="new">Backlog</option>
            <option value="work">In Progress</option>
            <option value="done">Done</option>
          </select>
        </div>

        <div class="danger-box" *ngIf="isChief || isAdmin">
          <div class="danger-label">Danger Zone</div>
          <button type="button" class="btn-danger-full" (click)="confirmDelete()">Delete Task</button>
        </div>

        <div class="modal-buttons">
          <button type="button" class="btn-secondary" (click)="closeEditModal()">Close</button>
          <button type="submit" class="btn-primary" [disabled]="!editForm.form.valid || (!isChief && !isAdmin)">Save</button>
        </div>
      </form>
    </div>

    <!-- Discussion -->
    <app-issue-page-template #issuePage *ngIf="!isTaskboardSelected"></app-issue-page-template>
  </div>
</div>
