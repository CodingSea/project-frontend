<div class="app">

    <app-sidebar />

    <main class="main">
        <header class="header">
            <h1>Dashboard</h1>
        </header>

        <div class="dashboard-grid">
            <section class="card progress-chart">
                <!-- Placeholder donut chart -->
                <svg width="150" height="150" viewBox="0 0 36 36" class="circular-chart">
                    <circle class="circle-bg" stroke="#f3f4f6" stroke-width="3" fill="none" cx="18" cy="18" r="15" />

                    <!-- At Risk Circle -->
                    <circle class="circle" stroke="#ef4444" stroke-width="3"
                        [attr.stroke-dasharray]="formatDecimal(projectStatusRate.completed + projectStatusRate.inProgress + projectStatusRate.atRisk) + ', 100'"
                        stroke-linecap="round" fill="none" cx="18" cy="18" r="15" transform="rotate(-90,18,18)" />

                    <!-- In Progress Circle (optional, if you want to visualize it separately) -->
                    <circle class="circle" stroke="#6366f1" stroke-width="3"
                        [attr.stroke-dasharray]="formatDecimal(projectStatusRate.completed + projectStatusRate.inProgress) + ', 100'"
                        stroke-linecap="round" fill="none" cx="18" cy="18" r="15" transform="rotate(-90,18,18)" />

                    <!-- Completed Circle -->
                    <circle class="circle" stroke="#22c55e" stroke-width="3"
                        [attr.stroke-dasharray]="formatDecimal(projectStatusRate.completed) + ', 100'"
                        stroke-linecap="round" fill="none" cx="18" cy="18" r="15" transform="rotate(-90,18,18)" />
                </svg>
                <div class="legend">
                    <span><span class="dot completed"></span>Completed</span>
                    <span><span class="dot inprogress"></span>In Progress</span>
                    <span><span class="dot atrisk"></span>At Risk</span>
                </div>
                <div class="percent">{{ formatDecimal(projectStatusRate.completed) }}%</div>
                <div class="label">Overall Completion</div>
            </section>

            <div class="achievements-container">
                <h2>Recent Notifications</h2>

                <h3>In-Review Services</h3>
                <table class="tasks-table">
                    <thead>
                        <tr>
                            <th>Project Title</th>
                            <th>Status</th>
                            <th>Deadline</th>
                            <th>Progress</th>
                        </tr>
                    </thead>
                    <tbody class="closest-services">
        
                        <tr *ngFor="let service of closestInReviewServices; let i = index">
                            <td>
                                <strong (click)="goTo(`/services/${service.serviceID}/taskboard/${service.taskBoard?.id}`)">{{ service.name }}</strong><br />
                                <small (click)="goTo(`/projects/${service.project.projectID}/services`)">{{ service.project.name }}</small>
                                <!-- You can add a subtitle or description here if needed -->
                            </td>
                            <td class="status">
                                <span class="status-badge" [ngClass]="{
                                    'completed': service.status === 'Completed',
                                    'at-risk': service.status === 'At Risk',
                                    'overdue': service.status === 'Overdue',
                                    'in-progress': service.status === 'In-Progress'
                                }">{{ service.status }}</span>
                            </td>
                            <td>
                                <strong>{{ service.deadline | date:'MMM d, y' }}</strong>
                            </td>
                            <td class="progress-tr">
                                @if(service.taskBoard?.cards?.length === 0)
                                {
                                    <strong>No Tasks</strong>
                                }
                                @else 
                                {
                                    <div class="progress-container" style="width: 120px">
                                        @if(service.status == "Completed")
                                        {
                                        <div class="progress-bar-filled" style=" background: #22c55e"
                                            [style.width.%]="service.completionRate"></div>
                                        }
                                        @else if(service.status == "At Risk")
                                        {
                                        <div class="progress-bar-filled" style=" background: #ef4444"
                                            [style.width.%]="service.completionRate"></div>
                                        }
                                        @else if(service.status == "In-Progress")
                                        {
                                        <div class="progress-bar-filled" style=" background: #6366f1"
                                            [style.width.%]="service.completionRate"></div>
                                        }
                                        @else if(service.status == "Overdue")
                                        {
                                        <div class="progress-bar-filled" style=" background: #000000"
                                            [style.width.%]="service.completionRate"></div>
                                        }
                                    </div>
                                    {{ formatDecimal(service.completionRate!) }}%
                                }
        
                                
                            </td>
                        </tr>
        
                    </tbody>
                </table>

                <hr>

                <h3>Certifications</h3>
                <div  class="certificates-container">
                    <div *ngFor="let c of certificates">
                        <div class="achievement">
                            <div class="icon completed"></div>
                            <div class="achievement-details">
                                <h3>{{ c.name }}</h3>
                                <p>By {{c.user?.first_name}} {{c.user?.last_name}} â€¢ {{ c.createdAt | date:"dd/MM/yyyy" }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <h2 class="tasks-header">Projects with the most imminent deadline</h2>

        <table class="tasks-table">
            <thead>
                <tr>
                    <th>Project Title</th>
                    <th>Status</th>
                    <th>Deadline</th>
                    <th>Progress</th>
                </tr>
            </thead>
            <tbody class="closest-services">

                <tr *ngFor="let service of closestServices; let i = index">
                    <td>
                        <strong (click)="goTo(`/services/${service.serviceID}/taskboard/${service.taskBoard?.id}`)">{{ service.name }}</strong><br />
                        <small (click)="goTo(`/projects/${service.project.projectID}/services`)">{{ service.project.name }}</small>
                        <!-- You can add a subtitle or description here if needed -->
                    </td>
                    <td class="status">
                        <span class="status-badge" [ngClass]="{
                            'completed': service.status === 'Completed',
                            'at-risk': service.status === 'At Risk',
                            'overdue': service.status === 'Overdue',
                            'in-progress': service.status === 'In-Progress'
                        }">{{ service.status }}</span>
                    </td>
                    <td>
                        <strong>{{ service.deadline | date:'MMM d, y' }}</strong>
                    </td>
                    <td class="progress-tr">
                        @if(service.taskBoard?.cards?.length === 0)
                        {
                            <strong>No Tasks</strong>
                        }
                        @else 
                        {
                            <div class="progress-container" style="width: 120px">
                                @if(service.status == "Completed")
                                {
                                <div class="progress-bar-filled" style=" background: #22c55e"
                                    [style.width.%]="service.completionRate"></div>
                                }
                                @else if(service.status == "At Risk")
                                {
                                <div class="progress-bar-filled" style=" background: #ef4444"
                                    [style.width.%]="service.completionRate"></div>
                                }
                                @else if(service.status == "In-Progress")
                                {
                                <div class="progress-bar-filled" style=" background: #6366f1"
                                    [style.width.%]="service.completionRate"></div>
                                }
                                @else if(service.status == "Overdue")
                                {
                                <div class="progress-bar-filled" style=" background: #000000"
                                    [style.width.%]="service.completionRate"></div>
                                }
                            </div>
                            {{ formatDecimal(service.completionRate!) }}%
                        }

                        
                    </td>
                </tr>

            </tbody>
        </table>
    </main>
</div>