<app-sidebar *ngIf="!isEmbedded" />

<div class="profile-wrapper">
  <div class="profile-box">
    <!-- ===== Top Header with Edit Button ===== -->
    <div class="profile-header">
      <div class="profile-top">
        <div class="avatar-section">
          <div class="image-upload">
            <div class="image-wrapper" [class.loading]="isImageLoading">
              <img
                [src]="previewImage || currentUserInfo.profileImage || 'images/user.png'"
                alt="Profile Image"
                class="profile-image"
                (click)="onProfileImageClick()"
                (load)="onImageLoad()"
                (error)="onImageError()"
                [style.opacity]="isImageLoading ? '0' : '1'"
              />
            </div>

            <!-- Plus icon (if no image) -->
            <label *ngIf="isEditing && !currentUserInfo.profileImage && !previewImage" class="plus-icon-container">
              <span class="plus-icon">+</span>
              <input type="file" accept="image/*" (change)="onProfileImageSelected($event)" hidden />
            </label>
          </div>

          <!-- Image Options Popup (only in edit mode) -->
          <div *ngIf="isEditing && showImageOptions" class="image-options-overlay" (click)="closeImageOptions($event)">
            <div class="image-options-modal center" (click)="$event.stopPropagation()">
              <h4 class="image-options-title">Profile Image</h4>
              <button class="option" (click)="triggerChangeImage()">
                <i class="fa fa-image"></i> Change Image
              </button>
              <button class="option delete" (click)="removeTempImage()">
                <i class="fa fa-trash"></i> Remove Image
              </button>
              <button class="option cancel" (click)="showImageOptions = false">Cancel</button>
            </div>
          </div>

          <!-- Hidden file input for change -->
          <input
            id="fileInput"
            type="file"
            #fileInput
            accept="image/*"
            (change)="onProfileImageSelected($event)"
            hidden
          />

        </div>

        <div class="info-section">
          <div *ngIf="!isEditing">
            <h2>{{ currentUserInfo.username }}</h2>
            <p class="email">{{ currentUserInfo.email }}</p>
            <span class="role">{{ currentUserInfo.role }}</span>
          </div>

          <div *ngIf="isEditing" class="edit-fields">
            <div class="name-inputs">
              <div>
                <label>First Name</label>
                <input type="text" [(ngModel)]="currentUser!.first_name" />
              </div>
              <div>
                <label>Last Name</label>
                <input type="text" [(ngModel)]="currentUser!.last_name" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit button top-right -->
      <div *ngIf="isCurrentUser" class="edit-btn-top">
        <button *ngIf="!isEditing" class="btn btn-primary" (click)="toggleEdit()">Edit Profile</button>
        <div *ngIf="isEditing" class="edit-buttons">
          <button class="btn btn-secondary" (click)="toggleEdit()">Cancel</button>
          <button class="btn btn-save" (click)="saveProfile()">Save</button>
        </div>
      </div>
    </div>

    <hr class="divider" />

    <!-- ===== Skills Section ===== -->
    <div class="profile-section">
      <div class="section-header">
        <h3>Skills</h3>
        <button *ngIf="isCurrentUser && !isEditing" class="btn btn-add" (click)="toggleEdit()">+ Add</button>
      </div>

      <div *ngIf="!isEditing" class="tag-list">
        <span class="tag" *ngFor="let skill of currentUserInfo.skills">{{ skill }}</span>
        <p class="empty" *ngIf="currentUserInfo.skills?.length === 0">No skills added yet</p>
      </div>

      <div *ngIf="isEditing" class="skills-edit">
        <div class="skill-item" *ngFor="let skill of currentUserInfo.skills; let i = index">
          <input type="text" [(ngModel)]="currentUserInfo.skills[i]" />
          <button class="remove-skill" (click)="removeSkill(i)">×</button>
        </div>
        <div class="add-skill">
          <input type="text" [(ngModel)]="newSkill" placeholder="Add new skill" />
          <button class="btn btn-add" (click)="addSkill()">+ Add Skill</button>
        </div>
      </div>
    </div>

    <!-- ===== Certificates ===== -->
    <div class="profile-section">
      <div class="section-header">
        <h3>Certificates</h3>
        <button *ngIf="isCurrentUser && !isEditing" class="btn btn-add" routerLink="/certificate/new">+ Add</button>
      </div>

      <div class="tag-list mt-8">
        <div class="certificate-tag" *ngFor="let c of certificates; let i = index">
          <span class="tag" [class.clickable]="isEditing" (click)="isEditing && editCertificate(c.certificateID)">
            {{ c.name }}
          </span>
          <button *ngIf="isEditing && isCurrentUser" class="remove-skill" (click)="removeCertificateTemp(i); $event.stopPropagation()">×</button>
        </div>

        <p class="empty" *ngIf="!certificates?.length">No certificates uploaded</p>
      </div>
    </div>

    <!-- ===== Services ===== -->
    <div class="profile-section">
      <h3>Services</h3>
      <div class="services">
        <div class="service-card" *ngFor="let service of services" (click)="switchPage(service.serviceID, service.taskBoard?.id)">
          <h4>{{ service.name }}</h4>
        </div>
        <p class="empty" *ngIf="!services?.length">No assigned services</p>
      </div>
    </div>
  </div>
</div>
