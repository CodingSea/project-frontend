<button class="back-btn" (click)="goBack()" *ngIf="showBackBtn">
    <i class="fa-solid fa-arrow-left"></i> Back
  </button>

  <div class="issue-container">
    <div *ngIf="loading" class="loading">Loading issue...</div>
    <div *ngIf="error" class="error-alert">{{ error }}</div>

    <ng-container *ngIf="issue">

      <!-- ISSUE CARD -->
      <section class="issue-card issue-highlight">
        <div class="issue-header">
          <div class="meta-left">
            <span class="status-badge" [ngClass]="issue.status">{{ issue.status || 'Open' }}</span>
            <span class="category-badge" *ngIf="issue.category">{{ issue.category }}</span>
            <span class="issue-id">#{{ issue.id }}</span>
          </div>

          <div class="meta-right">
            <div class="avatar-wrapper" [class.loading]="isImageLoading['issueUser']">
              <img class="avatar-sm"
                [src]="fixImage(issue.createdBy?.profileImage)"
                (load)="onImgLoad('issueUser')"
                (error)="onImgError($event, 'issueUser')"
                [style.opacity]="isImageLoading['issueUser'] ? '0' : '1'"
              />
            </div>

            <span>{{ issue.createdBy?.first_name }} {{ issue.createdBy?.last_name }}</span>
            <span class="dot">•</span>
            <span class="time">{{ issue.createdAt | date:'medium' }}</span>
          </div>
        </div>

        <h1 class="issue-title">{{ issue.title }}</h1>
        <div class="markdown-body issue-body" [innerHTML]="issue.descriptionHtml"></div>

        <!-- Issue Attachments -->
        <div class="attachments-section" *ngIf="issue.attachments?.length">
          <div class="attachments-title">Issue Attachments</div>

          <div
            class="attachment-item"
            *ngFor="let file of issue.attachments"
            (click)="download(file)"
          >
            <div class="file-info">
              <i class="fa-regular fa-file-lines file-icon"></i>
              <span class="file-name">{{ file.name }}</span>
            </div>
            <i class="fa-solid fa-download download-icon"></i>
          </div>
        </div>

      </section>

      <!-- FEEDBACK SECTION -->
      <section class="solutions-wrapper">
        <div class="solutions-header-line">
          <span class="solutions-pipe"></span>
          <h2 class="section-title">Solutions</h2>
        </div>

        <div *ngIf="!issue.feedbacks?.length" class="empty-state">No solutions yet. Share your knowledge.</div>

        <article *ngFor="let fb of issue.feedbacks" [ngClass]="{'solution-card': true, 'accepted': fb.isAccepted}">

          <div *ngIf="fb.isAccepted" class="accepted-label">Accepted Solution</div>

          <div class="solution-header">
            <div class="meta-left">
              <div class="avatar-wrapper" [class.loading]="isImageLoading[fb.id!]">
                <img class="avatar-sm"
                  [src]="fixImage(fb.user?.profileImage)"
                  (load)="onImgLoad(fb.id!)"
                  (error)="onImgError($event, fb.id!)"
                  [style.opacity]="isImageLoading[fb.id!] ? '0' : '1'"
                />
              </div>

              <strong>{{ fb.user?.first_name }} {{ fb.user?.last_name }}</strong>
              <span class="dot">•</span>
              <span class="time">{{ fb.createdAt | date:'short' }}</span>
            </div>

            <button *ngIf="currentUserId === issue?.createdBy?.id"
                    class="accept-btn"
                    [ngClass]="{'accepted-btn': fb.isAccepted}"
                    (click)="acceptFeedback(fb.id!)">
              {{ fb.isAccepted ? 'Accepted' : 'Mark as Accepted' }}
            </button>
          </div>

          <div class="markdown-body solution-body" [innerHTML]="renderMarkdown(fb.content)"></div>

          <!-- Attachments -->
          <div class="attachments-section" *ngIf="fb.attachments?.length">
            <div class="attachments-title">Attachments</div>

            <div
              class="attachment-item"
              *ngFor="let file of fb.attachments"
              (click)="download(file)"
            >
              <div class="file-info">
                <i class="fa-regular fa-file-lines file-icon"></i>
                <span class="file-name">{{ file.name }}</span>
              </div>

              <i class="fa-solid fa-download download-icon"></i>
            </div>
          </div>

          <button class="reply-toggle" (click)="toggleReplyBox(fb.id!)">
            <i class="fa-regular fa-comment-dots"></i> Reply
          </button>

          <div *ngIf="showReplyBox[fb.id!]" class="reply-box-modern">
            <textarea
              class="reply-textarea"
              [(ngModel)]="replyContent[fb.id!]"
              placeholder="Write a reply..."
              rows="1"
              (input)="autoResize($event)"
            ></textarea>

            <button class="reply-send-btn"
              (click)="submitComment(fb.id!)"
              [disabled]="!replyContent[fb.id!]">
              <i class="fa-solid fa-paper-plane"></i>
            </button>
          </div>

        </article>

        <!-- ADD FEEDBACK -->
        <div class="add-solution-box feedback-box">
          <h3 class="add-feedback-title">Add Feedback</h3>

          <textarea [(ngModel)]="newFeedback" class="solution-textarea" placeholder="Write your feedback..."></textarea>

          <div class="file-chip-wrapper" *ngIf="selectedFiles.length">
            <div class="file-chip" *ngFor="let f of selectedFiles; let i=index">
              <i class="fa-solid fa-paperclip"></i>
              <span>{{ f.name }}</span>
              <button class="remove-file" (click)="removeFile(i)">x</button>
            </div>
          </div>

          <div class="action-row">
            <label class="file-upload">
              <i class="fa-solid fa-paperclip"></i> Attach
              <input type="file" hidden multiple (change)="onFileSelected($event)" />
            </label>

            <button class="submit-btn" (click)="submitFeedback()">Post Feedback</button>
          </div>
        </div>

      </section>
    </ng-container>
  </div>